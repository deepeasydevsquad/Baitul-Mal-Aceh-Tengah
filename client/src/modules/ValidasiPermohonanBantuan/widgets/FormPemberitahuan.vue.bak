<script setup lang="ts">
// Library
import BaseButton from '@/components/Button/BaseButton.vue';
import LoadingSpinner from '@/components/Loading/LoadingSpinner.vue';
import Confirmation from '@/components/Modal/Confirmation.vue';
import Notification from '@/components/Modal/Notification.vue';
import { computed, onBeforeUnmount, onMounted, ref } from 'vue';

// Composable
import { useConfirmation } from '@/composables/useConfirmation';
import { useNotification } from '@/composables/useNotification';

// Service
import { get_info_pemberitahuan, pemberitahuan } from '@/service/validasi_permohonan_bantuan';

// Composable: notification & confirmation
const { showNotification, notificationType, notificationMessage, displayNotification } =
  useNotification();

const { showConfirmDialog, confirmTitle, confirmMessage, displayConfirmation, confirm, cancel } =
  useConfirmation();

interface Props {
  isModalOpen: boolean;
  selectedValidasiPermohonanBantuan: any;
}

const props = defineProps<Props>();

const emit = defineEmits<{
  (e: 'close'): void;
  (e: 'status', payload: { error_msg?: string; error?: boolean }): void;
}>();

// State
const isLoading = ref(false);

// Function: Close modal
const closeModal = () => {
  if (isSubmitting.value) return;
  emit('close');
};

// Computed: Get rejected berkas list
const rejectedBerkas = computed(() => {
  if (!props.selectedValidasiPermohonanBantuan?.syarat_persyaratan) {
    return [];
  }
  return props.selectedValidasiPermohonanBantuan.syarat_persyaratan.filter(
    (syarat: any) => syarat.status_validasi === 'reject',
  );
});

// Computed: WhatsApp message preview
const whatsappMessage = computed(() => {
  const data = props.selectedValidasiPermohonanBantuan;
  if (!data || rejectedBerkas.value.length === 0) {
    return '';
  }

  let message = `Halo *${data.member_name}*,\n\n`;
  message += `Berkas permohonan bantuan Anda untuk kegiatan *"${data.nama_kegiatan}"* memiliki berkas yang ditolak:\n\n`;

  rejectedBerkas.value.forEach((berkas: any, index: number) => {
    message += `${index + 1}. *${berkas.syarat_name}*\n`;
    if (berkas.alasan_penolakan) {
      message += `   Alasan: ${berkas.alasan_penolakan}\n`;
    }
    message += `\n`;
  });

  message += `Mohon lengkapi berkas yang ditolak dan upload ulang.\n\n`;
  message += `Terima kasih.`;

  return message;
});

// Function: Handle submit
const isSubmitting = ref(false);

const handleSubmit = async () => {
  if (rejectedBerkas.value.length === 0) {
    displayNotification('Tidak ada berkas yang ditolak untuk dikirim', 'warning');
    return;
  }

  displayConfirmation(
    'Konfirmasi Pengiriman WhatsApp',
    `Kirim pemberitahuan ke ${props.selectedValidasiPermohonanBantuan.member_name}?`,
    async () => {
      isSubmitting.value = true;

      const payload = {
        realisasi_id: props.selectedValidasiPermohonanBantuan.realisasi_id,
      };

      try {
        const response = await pemberitahuan(payload);

        if (response.error) {
          displayNotification(response.error_msg || 'Gagal mengirim pemberitahuan', 'error');
        } else {
          emit('status', {
            error_msg: response.error_msg || 'Pemberitahuan WhatsApp berhasil dikirim',
            error: false,
          });
          closeModal();
        }
      } catch (error: any) {
        console.error('Error send notification:', error);
        displayNotification(
          error.response?.data?.error_msg ||
            error.response?.data?.message ||
            'Gagal mengirim pemberitahuan',
          'error',
        );
      } finally {
        isSubmitting.value = false;
      }
    },
  );
};

// Function: Handle escape
const handleEscape = (e: KeyboardEvent) => {
  if (e.key === 'Escape' && props.isModalOpen) closeModal();
};

onMounted(() => {
  document.addEventListener('keydown', handleEscape);
});

onBeforeUnmount(() => {
  document.removeEventListener('keydown', handleEscape);
});
</script>

<template>
  <Transition
    enter-active-class="transition ease-out duration-200"
    enter-from-class="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
    enter-to-class="opacity-100 translate-y-0 sm:scale-100"
    leave-active-class="transition ease-in duration-150"
    leave-from-class="opacity-100 translate-y-0 sm:scale-100"
    leave-to-class="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
  >
    <div
      v-if="isModalOpen"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
    >
      <LoadingSpinner v-if="isLoading" label="Memuat data..." />
      <div v-else class="relative max-w-2xl w-full bg-white shadow-2xl rounded-2xl p-6 space-y-6">
        <!-- Header -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <font-awesome-icon icon="fa-brands fa-whatsapp" class="text-green-600 text-xl" />
            </div>
            <div>
              <h2 id="modal-title" class="text-xl font-bold text-gray-800">
                Pemberitahuan WhatsApp
              </h2>
              <p class="text-sm text-gray-500">Preview pesan sebelum dikirim</p>
            </div>
          </div>
          <button
            class="text-gray-400 text-lg hover:text-gray-600"
            @click="closeModal"
            aria-label="Tutup modal"
          >
            <font-awesome-icon icon="fa-solid fa-xmark" />
          </button>
        </div>

        <!-- Info Pemohon -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 shadow-sm">
          <h3 class="font-semibold text-blue-800 text-sm mb-3 flex items-center gap-2">
            <font-awesome-icon icon="fa-solid fa-user" />
            Informasi Penerima
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs text-blue-800">
            <p>
              <span class="font-semibold text-blue-900">Nama:</span>
              {{ selectedValidasiPermohonanBantuan?.member_name || '-' }}
            </p>
            <p>
              <span class="font-semibold text-blue-900">Kegiatan:</span>
              {{ selectedValidasiPermohonanBantuan?.nama_kegiatan || '-' }}
            </p>
            <p>
              <span class="font-semibold text-blue-900">Lokasi:</span>
              {{ selectedValidasiPermohonanBantuan?.desa_name || '-' }},
              {{ selectedValidasiPermohonanBantuan?.kecamatan_name || '-' }}
            </p>
          </div>
        </div>

        <!-- Berkas Ditolak List -->
        <div class="bg-red-50 border border-red-200 rounded-xl p-4">
          <h3 class="font-semibold text-red-800 text-sm mb-3 flex items-center gap-2">
            <font-awesome-icon icon="fa-solid fa-xmark-circle" />
            Berkas yang Ditolak ({{ rejectedBerkas.length }})
          </h3>

          <div v-if="rejectedBerkas.length > 0" class="space-y-2">
            <div
              v-for="(berkas, index) in rejectedBerkas"
              :key="berkas.syarat_id"
              class="bg-white border border-red-200 rounded-lg p-3"
            >
              <div class="flex items-start gap-3">
                <div
                  class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
                >
                  <span class="text-white text-xs font-bold">{{ index + 1 }}</span>
                </div>
                <div class="flex-1">
                  <p class="font-semibold text-gray-800 text-sm">{{ berkas.syarat_name }}</p>
                  <p v-if="berkas.alasan_penolakan" class="text-xs text-red-700 mt-1">
                    <strong>Alasan:</strong> {{ berkas.alasan_penolakan }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div v-else class="text-center py-6 text-red-600">
            <font-awesome-icon icon="fa-solid fa-inbox" class="text-3xl mb-2" />
            <p class="text-sm font-semibold">Tidak ada berkas yang ditolak</p>
          </div>
        </div>

        <!-- WhatsApp Message Preview -->
        <div class="bg-gray-50 border border-gray-300 rounded-xl p-4">
          <h3 class="font-semibold text-gray-800 text-sm mb-3 flex items-center gap-2">
            <font-awesome-icon icon="fa-solid fa-message" />
            Preview Pesan WhatsApp
          </h3>
          <div class="bg-white border border-gray-200 rounded-lg p-4 max-h-64 overflow-y-auto">
            <pre class="text-xs text-gray-700 whitespace-pre-wrap font-sans">{{
              whatsappMessage
            }}</pre>
          </div>
        </div>

        <!-- Warning Box -->
        <div
          v-if="rejectedBerkas.length > 0"
          class="bg-yellow-50 border border-yellow-200 rounded-lg p-4"
        >
          <div class="flex items-start gap-3">
            <font-awesome-icon
              icon="fa-solid fa-triangle-exclamation"
              class="text-yellow-600 text-lg mt-0.5"
            />
            <div class="text-xs text-yellow-800">
              <p class="font-semibold mb-1">Perhatian!</p>
              <p>
                Pesan WhatsApp akan dikirim ke pemohon berisi informasi berkas yang ditolak beserta
                instruksi untuk melengkapi berkas.
              </p>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-3">
          <BaseButton
            @click="closeModal"
            type="button"
            :disabled="isSubmitting"
            variant="secondary"
          >
            Batal
          </BaseButton>
          <BaseButton
            type="button"
            variant="success"
            :disabled="rejectedBerkas.length === 0 || isSubmitting"
            @click="handleSubmit"
          >
            <span v-if="isSubmitting">
              <font-awesome-icon icon="fa-solid fa-spinner" spin class="mr-2" />
              Mengirim...
            </span>
            <span v-else>
              <font-awesome-icon icon="fa-brands fa-whatsapp" class="mr-2" />
              Kirim WhatsApp
            </span>
          </BaseButton>
        </div>
      </div>
    </div>
  </Transition>

  <!-- Confirmation -->
  <Confirmation
    :showConfirmDialog="showConfirmDialog"
    :confirmTitle="confirmTitle"
    :confirmMessage="confirmMessage"
  >
    <BaseButton variant="secondary" @click="cancel">Batal</BaseButton>
    <BaseButton variant="success" @click="confirm">Ya, Kirim</BaseButton>
  </Confirmation>

  <!-- Notification -->
  <Notification
    :showNotification="showNotification"
    :notificationType="notificationType"
    :notificationMessage="notificationMessage"
    @close="showNotification = false"
  />
</template>
